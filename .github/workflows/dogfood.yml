name: dogfood merge
# This workflow is triggered on pushes to master and dogfood branches
on:
  push:
    branches:
      - master
      - 'dogfood/*'
# commenting 'delete' action, as it is triggered way too often
#  delete:
#    branches:
#      - 'dogfood/*'

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  SLACK_USERNAME: Dogfood build action      
      
jobs:
  dogfood_merge:
    runs-on: ubuntu-latest
    name: Update dogfood branch
    steps:
    - name: git octopus step     
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      id: dogfood
      uses: SonarSource/gh-action_dogfood_merge@master
      with:
        dogfood-branch: 'dogfood-on-peach'
    # Use the output from the `dogfood` step
    - name: Get the name of the dogfood branch and its HEAD SHA1
      run: echo "The dogfood branch was `${{ steps.dogfood.outputs.dogfood-branch }}` and its HEAD SHA1 was `${{ steps.dogfood.outputs.sha1 }}`"
    #slack notifications
    - name: Notify success on Slack
      uses: Ilshidur/action-slack@1.6.2
      env:
        SLACK_OVERRIDE_MESSAGE: 'Dogfood build for `${{ steps.dogfood.outputs.sha1 }}`: *successful*'
      with:
        args: 'Succeed to build dogfood branch'
    - name: Notify failures on Slack
      uses: Ilshidur/action-slack@1.6.2
      if: failure()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_USERNAME: Dogfood build action      
        SLACK_OVERRIDE_MESSAGE: 'Dogfood build for `${{ steps.dogfood.outputs.sha1 }}`: *failed*, see the logs at https://github.com/SonarSource/sonar-java/actions'
      with:
        args: 'Fail to build dogfood branch'

